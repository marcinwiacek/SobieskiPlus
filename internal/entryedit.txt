<!doctype html>
<html><head>
<meta charset='utf-8'>
<title><!--TITLE--></title>
<!--STYLES-->
</head><body>
<!--MENU-->
<div class=content>
<link type="text/css" rel="stylesheet" href="external/suneditor.min.css">
<script src="external/suneditor.min.js"></script>
<div class=ramki>
Edycja tekstu w dziale <!--RODZAJ-->
</div>
<div class=ramki>
  <form id=textedit name=textedit method=post>
      Status:<!--STATE-->
      Typ:<!--TYPE-->
      Tagi (opcjonalne)<p>
      <!--TAXONOMY-->
      <!--SPECIAL-TAXONOMY-->
      Tytuł: <input name="title" id=title type="text" value="<!--TITLE-->" placeholder="Bez tytułu się nie obędzie" size=50><p>
      Informacja dla czytających
      <textarea id="teaser-editor-container"><!--TEASER--></textarea><p>
      Tekst
      <textarea id="editor-container"><!--TEXT--></textarea><p>
      <button type="submit" id=sub>Zapisz</button>
  </form>
  <div style='display:none' id=progressinfo>Postęp: <progress id="progress" value="0"></progress><div id=progresserror></div></div>
</div>
<script async=async>

var teasersuneditor = SUNEDITOR.create('teaser-editor-container',{
  height : '100%',
  width:'auto',
  showPathLabel : false,
  charCounter : true,
  placeholder: 'Może być pusty'
});

var suneditor = SUNEDITOR.create('editor-container',{
  height : '100%',
  width:'auto',
  showPathLabel : false,
  charCounter : true,
  placeholder: 'Poproszę o ładny tekst'
});

var type0 = document.getElementById("textedit").elements.namedItem("type").value; 
var state0 = document.getElementById("textedit").elements.namedItem("state").value; 
var title0 = document.getElementById("textedit").elements.namedItem("title").value; 
var taxonomy0 = getListValues("taxonomy");
if (document.getElementById("textedit").elements.namedItem("specialtaxonomy")!=null) {
  var specialtaxonomy0 = getListValues("specialtaxonomy"); 
} else {
  var specialtaxonomy0 = "";
}
var text0 = suneditor.getContents(true);

document.getElementById('sub').disabled=true;

var updated = false;
function sprawdz() {
  updated = true;
  if (suneditor.getContents(true).trim().length==0 || 
      document.getElementById("textedit").elements.namedItem("title").value=="") {
    document.getElementById('sub').disabled=true;
  } else {
    if (type0 != document.getElementById("textedit").elements.namedItem("type").value ||
      state0 != document.getElementById("textedit").elements.namedItem("state").value ||
      title0 != document.getElementById("textedit").elements.namedItem("title").value ||
      taxonomy0 != getListValues("taxonomy") ||
      (document.getElementById("textedit").elements.namedItem("specialtaxonomy")!=null &&
           specialtaxonomy0 != getListValues("specialtaxonomy")) ||
      text0 != suneditor.getContents(true)) {
    document.getElementById('sub').disabled=false;
  } else {
    document.getElementById('sub').disabled=true;
  }

  }
}

suneditor.onChange = function (contents, core) { sprawdz() }
var e = document.getElementsByTagName("input");
for (var i=0;i<e.length;i++) {
  e[i].addEventListener("click", sprawdz);
}
var e = document.getElementsByTagName("option");
for (var i=0;i<e.length;i++) {
  e[i].addEventListener("click", sprawdz);
}

window.onbeforeunload = function(){
  if (document.getElementById('sub').disabled==false) return 'Tekst jest niezapisany. Czy na pewno chcesz opuścić edytor?';
};

function getListValues(name) {
  var result = "";
  for (var i=0, len=document.getElementById(name).options.length; i<len; i++) {
        opt = document.getElementById(name).options[i];
        if (opt.selected) result += opt.value+",";
  }
  return result.slice(0, -1);
}

document.textedit.onsubmit = function() {
  var type = document.getElementById("textedit").elements.namedItem("type").value; 
  if (type == '') {
	alert('Proszę wybrać typ');
	return false;
  }
  var state = document.getElementById("textedit").elements.namedItem("state").value; 
  var title = document.getElementById("textedit").elements.namedItem("title").value; 
  var taxonomy = getListValues("taxonomy");
  if (document.getElementById("textedit").elements.namedItem("specialtaxonomy")!=null) {
    var specialtaxonomy = getListValues("specialtaxonomy"); 
  } else {
    var specialtaxonomy ="";
  }
  var progressBar = document.getElementById("progress");
  var http = new XMLHttpRequest();
  var url = window.location.protocol+'//'+window.location.hostname+':'+window.location.port+window.location.pathname;
  var params = 'q=upload_text&tekst=<!--PAGEID-->';
  if (<!--PAGEID-->==0 || state!=state0) params+='&state='+state;
  if (title!=title0) params+='&title='+title;
  if (<!--PAGEID-->==0 || type!=type0) params+='&type='+type;
  if (taxonomy!=taxonomy0) params+='&taxonomy='+taxonomy;
  if (suneditor.getContents(true)!=text0) params+='&text='+decodeURIComponent(suneditor.getContents(true));
  if (teasersuneditor.getContents(true)!='') params+='&teaser='+decodeURIComponent(teasersuneditor.getContents(true));
  if (specialtaxonomy!=specialtaxonomy0) params+='&specialtaxonomy='+specialtaxonomy;
  http.open('POST', url, true);
  http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  http.onprogress = function(e) {
    if (e.lengthComputable) {
        progressBar.max = e.total;
        progressBar.value = e.loaded;
    }
  };
  http.onloadstart = function() {
    document.getElementById("progressinfo").style.display="block";
    document.getElementById("progress").innerHTML="";
    progressBar.value = 0;
  };
  http.onload = function() {
    document.getElementById('sub').disabled=true;
    if (<!--PAGEID--> == 0) {
      window.location.href='?q='+http.response;
    } else {
      progressBar.value = progressBar.max;
      document.getElementById("progressinfo").style.display="none";
    }
  };
  http.onerror = function () {
    document.getElementById("progress").innerHTML="error";
  };

  http.send(params);

  return false;
};
</script>
</div></body></html>