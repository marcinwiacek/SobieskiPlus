<!doctype html>
<html><head>
<meta charset='utf-8'>
<title><!--TITLE--></title>
<!--STYLES-->
</head><body>
<!--MENU-->
<div class=content>
<link type="text/css" rel="stylesheet" href="external/quill.snow.css">
<script src="external/quill.min.js"></script>

<!--RODZAJ--><br>
<div class=ramki>
  <form id=textedit name=textedit method=post>
      Status:<!--STATE-->
      Typ:<!--TYPE-->
      <!--TAXONOMY-->
      <!--SPECIAL-TAXONOMY-->
      Tytuł: <input name="title" id=title type="text" value="<!--TITLE-->" placeholder="Bez tytułu się nie obędzie" size=50>
      <div id="editor-container"><!--TEXT--></div>
      <button type="submit" id=sub>Zapisz</button>
  </form>
  <div style='display:none' id=progressinfo>Postęp: <progress id="progress" value="0"></progress><div id=progresserror></div></div>
  Licznik ze spacjami: <span id="counter"></span>
</div>
<script async=async>

var toolbarOptions = [
  ['bold', 'italic', 'underline', 'strike'],
  ['blockquote', 'code-block', 'image'],

  [{ 'header': 1 }, { 'header': 2 }],
  [{ 'list': 'ordered'}, { 'list': 'bullet' }],
  [{ 'script': 'sub'}, { 'script': 'super' }],
  [{ 'indent': '-1'}, { 'indent': '+1' }],
  [{ 'direction': 'rtl' }],

  [{ 'size': ['small', false, 'large', 'huge'] }],
  [{ 'header': [1, 2, 3, 4, 5, 6, false] }],

  [{ 'color': [] }, { 'background': [] }],
  [{ 'font': [] }],
  [{ 'align': [] }],

  ['link', 'image', 'video'],

  ['clean']
];

var quill = new Quill('#editor-container', {
  modules: {
    toolbar: toolbarOptions,
    history: {
      delay: 2000,
      maxStack: 500,
      userOnly: true
    }
/* needs library: ,syntax: true */
  },
  placeholder: 'Bądź grzecznym misiem i zapodaj ładny tekst proszę...',
  theme: 'snow'
});

var updated = false;
function sprawdz() {
  updated = true;
  if (quill.getText().trim().length==0 || document.getElementById("textedit").elements.namedItem("title").value=="") {
    document.getElementById('sub').disabled=true;
  } else {
    document.getElementById('sub').disabled=false;
  }
  document.getElementById("counter").innerHTML=quill.getText().replace(/(\r\n|\n|\r)/gm, "").length;
}

document.getElementById('sub').disabled=true;
document.getElementById("counter").innerHTML=quill.getText().replace(/(\r\n|\n|\r)/gm, "").length;
quill.on('text-change', function(delta, oldDelta, source) {
  sprawdz();
});
document.getElementById("title").addEventListener("input", sprawdz);
document.getElementById("state").addEventListener("change", sprawdz);
document.getElementById("type").addEventListener("change", sprawdz);
document.getElementById("taxonomy").addEventListener("change", sprawdz);
if (document.getElementById("textedit").elements.namedItem("specialtaxonomy")!=null) {
  document.getElementById("specialtaxonomy").addEventListener("change", sprawdz);
}

window.onbeforeunload = function(){
  if (updated) return 'Tekst jest niezapisany. Czy na pewno chcesz opuścić edytor?';
};

function getListValues(name) {
  var result = "";
  for (var i=0, len=document.getElementById(name).options.length; i<len; i++) {
        opt = document.getElementById(name).options[i];
        if (opt.selected) result += opt.value+",";
  }
  return result;
}

document.textedit.onsubmit = function() {
  var type = document.getElementById("textedit").elements.namedItem("type").value; 
  if (type == '') {
	alert('Proszę wybrać typ');
	return false;
  }
  var state = document.getElementById("textedit").elements.namedItem("state").value; 
  var title = document.getElementById("textedit").elements.namedItem("title").value; 
  var taxonomy = getListValues("taxonomy");
  if (document.getElementById("textedit").elements.namedItem("specialtaxonomy")!=null) {
    var specialtaxonomy = getListValues("specialtaxonomy"); 
  }
  var progressBar = document.getElementById("progress");
  var http = new XMLHttpRequest();
  var url = window.location.protocol+'//'+window.location.hostname+':'+window.location.port+window.location.pathname;
  var params = 'q=upload_text&tekst=<!--PAGEID-->&state='+state+'&title='+title+'&type='+type+'&taxonomy='+taxonomy+'&text='+decodeURIComponent(quill.root.innerHTML);
  if (document.getElementById("textedit").elements.namedItem("specialtaxonomy")!=null) {
    params +='&specialtaxonomy='+specialtaxonomy;
  }
  http.open('POST', url, true);
  http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  http.onprogress = function(e) {
    if (e.lengthComputable) {
        progressBar.max = e.total;
        progressBar.value = e.loaded;
    }
  };
  http.onloadstart = function() {
    document.getElementById("progressinfo").style.display="block";
    document.getElementById("progress").innerHTML="";
    progressBar.value = 0;
  };
  http.onload = function() {
    if (<!--PAGEID--> == 0) {
      window.location.href='?q='+http.response;
    } else {
      progressBar.value = progressBar.max;
      document.getElementById("progressinfo").style.display="none";
    }
  };
  http.onerror = function () {
    document.getElementById("progress").innerHTML="error";
  };

  http.send(params);

  return false;
};
</script>
</div></body></html>