<!doctype html>
<html><head>
<meta charset='utf-8'>
<script src="external/sha256.js"></script>
<title>Nowe konto</title>
<!--STYLES-->
</head><body>
<!--MENU-->
<div class=content>
<div class=ramki>
Nowy użytkownik/edycja użytkownika
</div>
<div class=ramki>
<table>
<form id=textedit name=textedit method=post>

<tr><td colspan=2>
<input type="radio" <!--CHECKED-WLASNE--> name="typ" id="typ" value="wlasne" onClick="setWlasne()"><label for=typ>Konto z własnym hasłem (wymaga weryfikacji email)</label><p>
<input type="radio" <!--CHECKED-GOOGLE--> name="typ" id="typ" value="google" onClick="setGoogle()"><label for=typ>Konto z logowaniem przez Google (wymaga założonego konta Google z podanym email; weryfikacja maila przez Google)</label>
</td></tr>

<tr><td>Unikalny nick w serwisie:</td><td><input name="username" id=username type="text" size=50 <!--USER-PARAMS--></td></tr>
<tr><td>Unikalny mail w serwisie:</td><td><input name="mail" id=mail type="text" <!--MAIL-PARAMS--> size=50></td></tr>

<tr id=wlasne><td>Password:</td><td><input name="pass" id=pass type="text" value="" <!--PASS-PARAMS--> size=50><br></td></tr>
<tr id=wlasne2><td>Repeat password:</td><td><input name="pass2" id=pass2 type="text" value="" <!--PASS-PARAMS--> size=50></td></tr>

<tr><td colspan=2><button type="submit" id=sub>Zapisz</button></td></tr>
</form>
</table>
</div>
<script async=async>

function getRadio() {
  var r = "";
  var e = document.getElementsByTagName('input');               
  for(i = 0; i < e.length; i++) {                   
    if(e[i].type=="radio" && e[i].checked) {
	r = e[i].value;
	break;
    } 
  }
  return r;
}

function sprawdz() {
  if ("new_user"=="<!--OPERATION-->") {
    if (document.getElementById("textedit").elements.namedItem("username").value=="" ||
       document.getElementById("textedit").elements.namedItem("mail").value=="" ||
       (getRadio() == "wlasne" && (
        document.getElementById("textedit").elements.namedItem("pass").value=="" ||
        document.getElementById("textedit").elements.namedItem("pass2").value==""))) {
      document.getElementById('sub').disabled=true;
    } else {
      document.getElementById('sub').disabled=false;
    }
  } else {
    if (document.getElementById("textedit").elements.namedItem("mail").value=="") {
      document.getElementById('sub').disabled=true;
    } else {
      document.getElementById('sub').disabled=false;
    }
  }
}
sprawdz();
document.getElementById("username").addEventListener("input", sprawdz);
document.getElementById("mail").addEventListener("input", sprawdz);
document.getElementById("pass").addEventListener("input", sprawdz);
document.getElementById("pass2").addEventListener("input", sprawdz);

function setWlasne() {
  document.getElementById('wlasne').style.visibility="visible";
  document.getElementById('wlasne2').style.visibility="visible";
  sprawdz();
}

function setGoogle() {
  document.getElementById('wlasne').style.visibility="collapse";
  document.getElementById('wlasne2').style.visibility="collapse";
  sprawdz();
}

document.textedit.onsubmit = function() {
  if (getRadio() == "wlasne") {
    var pass = document.getElementById("textedit").elements.namedItem("pass").value; 
    var pass2 = document.getElementById("textedit").elements.namedItem("pass2").value; 
    if (pass != pass2) {
      alert('Hasła muszą się zgadzać');
      return false;
    }
  }
  var username = document.getElementById("textedit").elements.namedItem("username").value; 
  var mail = document.getElementById("textedit").elements.namedItem("mail").value; 

  var http = new XMLHttpRequest();
  var url = window.location.protocol+'//'+window.location.hostname+':'+window.location.port+window.location.pathname;
  if ("new_user"=="<!--OPERATION-->") {
    var params = 'q=<!--OPERATION-->&username='+username+'&mail='+mail;
    if (getRadio()=="wlasne") {
       params += '&typ=w&pass='+sha256(pass);
    } else {
       params += '&typ=g';
    }
  } else {
    var params = 'q=<!--OPERATION-->&mail='+mail;
    if (getRadio()=="wlasne") {
       params += '&typ=w';
       if (pass!="") params+='&pass='+pass;
    } else {
       params += '&typ=g';
    }
  }

  http.open('POST', url, true);
  http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  http.onload = function() {
    alert(http.response);
/*      window.location.href='?q='+http.response; */
  };
  http.onerror = function () {
    alert(http.response);
  };

  http.send(params);

  return false;
};
</script>
</div></body></html>